<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥æ”¶åˆ†äº«å¯†ç¢¼</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#667eea">
    
    <!-- iOS specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è©•åƒ¹ç³»çµ±">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Icons for various platforms -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .error-section {
            display: none;
            text-align: center;
        }

        .setup-section {
            display: none;
        }

        .success-section {
            display: none;
            text-align: center;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
        }

        .error-message h3 {
            margin-bottom: 10px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #28a745;
            margin-bottom: 20px;
        }

        .success-message h3 {
            margin-bottom: 10px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 5px solid #2196F3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .info-box h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #0c5460;
            line-height: 1.6;
        }

        .password-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .password-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .password-item h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .password-item p {
            color: #666;
            font-size: 0.9em;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        button:active {
            transform: scale(0.98);
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
        }

        .back-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 1em;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        /* Passcode Modal */
        .passcode-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .passcode-modal.active {
            display: flex;
        }

        .passcode-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .passcode-content h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .passcode-content p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .passcode-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .passcode-digit {
            width: 50px;
            height: 50px;
            border: 2px solid #667eea;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            background: #f8f9fa;
        }

        .passcode-digit.filled {
            background: #667eea;
            color: white;
        }

        .passcode-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .passcode-key {
            padding: 20px;
            font-size: 1.8em;
            font-weight: bold;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
        }

        .passcode-key:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .passcode-key:active {
            transform: scale(0.95);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .view-count-info {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }
    </style>
</head>
<body>
    <!-- Passcode Modal -->
    <div class="passcode-modal" id="passcodeModal">
        <div class="passcode-content">
            <h2>ğŸ”¢ è¨­å®šé€šè¡Œç¢¼</h2>
            <p id="passcodeModalMessage">è«‹è¨­å®šå››ä½æ•¸å­—é€šè¡Œç¢¼ä»¥ä¿è­·æ‚¨çš„å¯†ç¢¼</p>
            
            <div class="passcode-display">
                <div class="passcode-digit" id="digit1"></div>
                <div class="passcode-digit" id="digit2"></div>
                <div class="passcode-digit" id="digit3"></div>
                <div class="passcode-digit" id="digit4"></div>
            </div>

            <div class="passcode-keypad">
                <button class="passcode-key" onclick="passcodeKeyPress('1')">1</button>
                <button class="passcode-key" onclick="passcodeKeyPress('2')">2</button>
                <button class="passcode-key" onclick="passcodeKeyPress('3')">3</button>
                <button class="passcode-key" onclick="passcodeKeyPress('4')">4</button>
                <button class="passcode-key" onclick="passcodeKeyPress('5')">5</button>
                <button class="passcode-key" onclick="passcodeKeyPress('6')">6</button>
                <button class="passcode-key" onclick="passcodeKeyPress('7')">7</button>
                <button class="passcode-key" onclick="passcodeKeyPress('8')">8</button>
                <button class="passcode-key" onclick="passcodeKeyPress('9')">9</button>
                <button class="passcode-key" onclick="passcodeKeyPress('clear')">æ¸…é™¤</button>
                <button class="passcode-key" onclick="passcodeKeyPress('0')">0</button>
                <button class="passcode-key" onclick="passcodeKeyPress('back')">â†</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>ğŸ” æ¥æ”¶åˆ†äº«å¯†ç¢¼</h1>
        
        <div class="loading" id="loadingSection">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨è¼‰å…¥åˆ†äº«å…§å®¹...</p>
        </div>

        <div class="error-section" id="errorSection">
            <div class="error-message">
                <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
                <p id="errorText"></p>
            </div>
            <div class="back-link">
                <a href="index.html">â† è¿”å›ä¸»é </a>
            </div>
        </div>

        <div class="setup-section" id="setupSection">
            <div class="info-box">
                <h4>ğŸ“‹ å¦‚ä½•ä½¿ç”¨</h4>
                <p>
                    ç‚ºäº†ç¢ºä¿å¯†ç¢¼å®‰å…¨ï¼Œæ‚¨éœ€è¦è¨­å®šä¸€å€‹4ä½æ•¸å­—é€šè¡Œç¢¼ã€‚<br>
                    å¯†ç¢¼å°‡ä»¥åŠ å¯†å½¢å¼å„²å­˜åœ¨æ‚¨çš„è£ç½®ä¸Šï¼Œåªèƒ½ç”¨æ‚¨çš„é€šè¡Œç¢¼è§£é–ä½¿ç”¨ã€‚<br>
                    <strong>æ³¨æ„ï¼šæ•´å€‹éç¨‹ä¸­ï¼Œæ²’æœ‰äººèƒ½ç›´æ¥çœ‹åˆ°å¯†ç¢¼çš„æ˜æ–‡å…§å®¹ï¼</strong>
                </p>
            </div>

            <div class="view-count-info" id="viewCountInfo" style="display: none;">
                <strong>âš ï¸ æŸ¥çœ‹é™åˆ¶ï¼š</strong><span id="viewCountText"></span>
            </div>

            <div class="password-list" id="passwordList"></div>

            <button onclick="setupPasscode()">è¨­å®šé€šè¡Œç¢¼ä¸¦å„²å­˜å¯†ç¢¼</button>

            <div class="back-link">
                <a href="index.html">â† è¿”å›ä¸»é </a>
            </div>
        </div>

        <div class="success-section" id="successSection">
            <div class="success-message">
                <h3>âœ… å¯†ç¢¼å·²å®‰å…¨å„²å­˜</h3>
                <p id="successText"></p>
            </div>

            <div class="info-box">
                <h4>ğŸ¯ ä¸‹ä¸€æ­¥</h4>
                <p id="nextStepsText"></p>
            </div>

            <div class="back-link">
                <a href="index.html">â† å‰å¾€ä¸»é ä½¿ç”¨å¯†ç¢¼</a>
            </div>
        </div>
    </div>

    <script>
        // Version check for app update
        const CURRENT_VERSION = 2;
        const storedVersion = parseInt(localStorage.getItem('app_version') || '1');
        if (storedVersion < CURRENT_VERSION) {
            localStorage.setItem('app_version', CURRENT_VERSION.toString());
        }
        
        let shareData = null;
        let shareId = null;
        let passcodeBuffer = '';
        let passcodeSetupCallback = null;

        // Check if running as installed PWA
        function isInstalledPWA() {
            // Check if running in standalone mode (iOS/Android)
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return true;
            }
            // Check iOS standalone
            if (window.navigator.standalone === true) {
                return true;
            }
            // Check Android TWA or related
            if (document.referrer.includes('android-app://')) {
                return true;
            }
            return false;
        }

        // Check if device is mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Check if device is online
        function isOnline() {
            return navigator.onLine;
        }

        // Show PWA installation guide
        function showPWAInstallGuide() {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <h1>ğŸ“± è«‹å®‰è£æ‡‰ç”¨ç¨‹å¼</h1>
                <div class="info-box">
                    <h4>é«˜æ©Ÿå¯†æ¨¡å¼éœ€è¦å·²å®‰è£çš„ PWA</h4>
                    <p>
                        ç‚ºç¢ºä¿å®‰å…¨æ€§ï¼Œæ­¤åˆ†äº«é€£çµéœ€è¦é€éå·²å®‰è£çš„ç¶²é æ‡‰ç”¨ç¨‹å¼ï¼ˆPWAï¼‰å­˜å–ã€‚
                    </p>
                    <h4 style="margin-top: 20px;">ğŸ“² å¦‚ä½•å®‰è£ï¼š</h4>
                    <p>
                        <strong>iOS (Safari):</strong><br>
                        1. é»æ“Šåˆ†äº«æŒ‰éˆ• <span style="font-size: 1.2em;">â™</span><br>
                        2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€<br>
                        3. é»æ“Šã€Œæ–°å¢ã€<br><br>
                        
                        <strong>Android (Chrome):</strong><br>
                        1. é»æ“Šé¸å–®æŒ‰éˆ• â‹®<br>
                        2. é¸æ“‡ã€Œæ–°å¢è‡³ä¸»ç•«é¢ã€æˆ–ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€<br>
                        3. é»æ“Šã€Œå®‰è£ã€
                    </p>
                    <p style="margin-top: 20px; color: #d9534f;">
                        <strong>å®‰è£å®Œæˆå¾Œï¼Œè«‹å¾ä¸»ç•«é¢é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼ï¼Œä¸¦é‡æ–°æƒæ QR Codeã€‚</strong>
                    </p>
                </div>
                <div class="back-link">
                    <a href="index.html">â† è¿”å›ä¸»é </a>
                </div>
            `;
        }

        // AES-like encryption/decryption using Web Crypto API
        async function decryptData(encryptedBase64, password) {
            try {
                const encrypted = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                
                const salt = encrypted.slice(0, 16);
                const iv = encrypted.slice(16, 28);
                const data = encrypted.slice(28);
                
                const encoder = new TextEncoder();
                const passwordBuffer = encoder.encode(password);
                
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordBuffer,
                    'PBKDF2',
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                
                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                
                const decoder = new TextDecoder();
                return decoder.decode(decryptedData);
            } catch (error) {
                throw new Error('è§£å¯†å¤±æ•—');
            }
        }

        async function encryptData(data, password) {
            const encoder = new TextEncoder();
            const dataBuffer = encoder.encode(data);
            const passwordBuffer = encoder.encode(password);
            
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                passwordBuffer,
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );
            
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt']
            );
            
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encryptedData = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                dataBuffer
            );
            
            const result = new Uint8Array(salt.length + iv.length + encryptedData.byteLength);
            result.set(salt, 0);
            result.set(iv, salt.length);
            result.set(new Uint8Array(encryptedData), salt.length + iv.length);
            
            return btoa(String.fromCharCode.apply(null, result));
        }

        // Passcode functions
        function passcodeKeyPress(key) {
            if (key === 'clear') {
                passcodeBuffer = '';
            } else if (key === 'back') {
                passcodeBuffer = passcodeBuffer.slice(0, -1);
            } else if (passcodeBuffer.length < 4 && /^\d$/.test(key)) {
                passcodeBuffer += key;
            }
            
            updatePasscodeDisplay();
            
            if (passcodeBuffer.length === 4) {
                setTimeout(() => {
                    if (passcodeBuffer.length === 4) {
                        confirmPasscodeSetup();
                    }
                }, 300);
            }
        }

        function updatePasscodeDisplay() {
            for (let i = 1; i <= 4; i++) {
                const digitEl = document.getElementById('digit' + i);
                if (i <= passcodeBuffer.length) {
                    digitEl.textContent = 'â—';
                    digitEl.classList.add('filled');
                } else {
                    digitEl.textContent = '';
                    digitEl.classList.remove('filled');
                }
            }
        }

        function setupPasscode() {
            passcodeBuffer = '';
            passcodeSetupCallback = async (passcode) => {
                if (passcode) {
                    await savePasswordsWithPasscode(passcode);
                }
            };
            
            updatePasscodeDisplay();
            document.getElementById('passcodeModal').classList.add('active');
        }

        function confirmPasscodeSetup() {
            if (passcodeBuffer.length !== 4) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„4ä½æ•¸å­—ï¼');
                return;
            }
            
            const passcode = passcodeBuffer;
            const callback = passcodeSetupCallback;
            
            closePasscodeModal();
            
            if (callback) {
                callback(passcode);
            }
        }

        function closePasscodeModal() {
            document.getElementById('passcodeModal').classList.remove('active');
            passcodeBuffer = '';
            passcodeSetupCallback = null;
            updatePasscodeDisplay();
        }

        async function savePasswordsWithPasscode(passcode) {
            try {
                // Store each password encrypted with the user's passcode
                const storedPasswords = [];
                
                if (shareData.passwords.comment) {
                    const encryptedComment = await encryptData(shareData.passwords.comment, passcode);
                    localStorage.setItem('shared_comment_password', encryptedComment);
                    // NOTE: Storing passcode enables better UX (user doesn't re-enter each time)
                    // Trade-off: If localStorage is compromised, attacker gets both encrypted data and key
                    // Alternative would be to prompt for passcode on each use (more secure, less usable)
                    localStorage.setItem('passcode_comment', passcode);
                    
                    // Store passcode expiry timestamp
                    const expiryKey = 'passcode_expiry_comment_' + shareId;
                    const expiryTimestamp = Date.now() + (shareData.passcodeValidMinutes || 60) * 60000;
                    localStorage.setItem(expiryKey, expiryTimestamp.toString());
                    
                    storedPasswords.push('éŠ³è©•å¯†ç¢¼');
                }
                
                if (shareData.passwords.query) {
                    const encryptedQuery = await encryptData(shareData.passwords.query, passcode);
                    localStorage.setItem('shared_query_password', encryptedQuery);
                    // NOTE: See above comment about passcode storage trade-off
                    localStorage.setItem('passcode_query', passcode);
                    
                    // Store passcode expiry timestamp
                    const expiryKey = 'passcode_expiry_query_' + shareId;
                    const expiryTimestamp = Date.now() + (shareData.passcodeValidMinutes || 60) * 60000;
                    localStorage.setItem(expiryKey, expiryTimestamp.toString());
                    
                    storedPasswords.push('æŸ¥è©¢å¯†ç¢¼');
                }
                
                // Mark high security mode activation time
                if (shareData.highSecurity && shareData.noAuthDuration > 0) {
                    const activationKey = 'share_activated_' + shareId;
                    localStorage.setItem(activationKey, Date.now().toString());
                }
                
                // Update view count
                if (shareData.viewLimit > 0) {
                    const viewCountKey = 'share_view_count_' + shareId;
                    const currentCount = parseInt(localStorage.getItem(viewCountKey) || '0');
                    localStorage.setItem(viewCountKey, (currentCount + 1).toString());
                }
                
                // Show success
                showSuccess(storedPasswords);
            } catch (error) {
                showError('å„²å­˜å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }

        async function savePasswordsDirectly() {
            try {
                // For high security mode within no-auth period, save directly without passcode
                const storedPasswords = [];
                
                if (shareData.passwords.comment) {
                    // Use a default passcode for encryption (user won't need to remember it)
                    const autoPasscode = generateRandomKey(16);
                    const encryptedComment = await encryptData(shareData.passwords.comment, autoPasscode);
                    localStorage.setItem('shared_comment_password', encryptedComment);
                    localStorage.setItem('passcode_comment', autoPasscode);
                    storedPasswords.push('éŠ³è©•å¯†ç¢¼');
                }
                
                if (shareData.passwords.query) {
                    const autoPasscode = generateRandomKey(16);
                    const encryptedQuery = await encryptData(shareData.passwords.query, autoPasscode);
                    localStorage.setItem('shared_query_password', encryptedQuery);
                    localStorage.setItem('passcode_query', autoPasscode);
                    storedPasswords.push('æŸ¥è©¢å¯†ç¢¼');
                }
                
                // Mark activation time for high security mode
                const activationKey = 'share_activated_' + shareId;
                localStorage.setItem(activationKey, Date.now().toString());
                
                // Update view count
                if (shareData.viewLimit > 0) {
                    const viewCountKey = 'share_view_count_' + shareId;
                    const currentCount = parseInt(localStorage.getItem(viewCountKey) || '0');
                    localStorage.setItem(viewCountKey, (currentCount + 1).toString());
                }
                
                // Show success
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('successSection').style.display = 'block';
                
                const successText = `å·²æˆåŠŸå•Ÿç”¨ ${storedPasswords.join('ã€')}ï¼\né«˜æ©Ÿå¯†æ¨¡å¼å·²å•Ÿå‹•ï¼Œåœ¨æ™‚é™å…§ç„¡éœ€è¼¸å…¥é€šè¡Œç¢¼ã€‚`;
                document.getElementById('successText').textContent = successText;
                
                const remainingTime = Math.floor(shareData.noAuthDuration / 60000);
                let nextSteps = `â±ï¸ å…é©—è­‰æ™‚é™ï¼š${remainingTime} åˆ†é˜\n\n`;
                nextSteps += 'æ‚¨ç¾åœ¨å¯ä»¥ï¼š\n';
                if (shareData.passwords.comment) {
                    nextSteps += 'â€¢ å‰å¾€ä¸»é ï¼ŒæŸ¥è©¢åº§è™Ÿå¾Œç›´æ¥æŸ¥çœ‹éŠ³è©•ï¼ˆç„¡éœ€é€šè¡Œç¢¼ï¼‰\n';
                }
                if (shareData.passwords.query) {
                    nextSteps += 'â€¢ å‰å¾€ä¸»é ï¼Œç›´æ¥é€²è¡Œå¤šæ¬¡æŸ¥è©¢ï¼ˆç„¡éœ€é€šè¡Œç¢¼ï¼‰\n';
                }
                nextSteps += '\nâš ï¸ æ™‚é™åˆ°æœŸå¾Œï¼Œæ‚¨éœ€è¦é‡æ–°æƒæ QR Code ä»¥é‡æ–°å•Ÿç”¨ã€‚';
                
                document.getElementById('nextStepsText').textContent = nextSteps;
            } catch (error) {
                showError('å„²å­˜å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }

        function generateRandomKey(length) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let key = '';
            for (let i = 0; i < length; i++) {
                key += chars.charAt(array[i] % chars.length);
            }
            return key;
        }

        async function loadSharedData() {
            try {
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const encryptedData = urlParams.get('data');
                const key = urlParams.get('key');
                
                if (!encryptedData || !key) {
                    showError('ç„¡æ•ˆçš„åˆ†äº«é€£çµï¼ç¼ºå°‘å¿…è¦åƒæ•¸ã€‚');
                    return;
                }
                
                // Generate share ID for tracking using SHA-256 hash
                const encoder = new TextEncoder();
                const data = encoder.encode(encryptedData + key);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                shareId = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32);
                
                // Decrypt the share data
                const decryptedJson = await decryptData(decodeURIComponent(encryptedData), decodeURIComponent(key));
                shareData = JSON.parse(decryptedJson);
                
                // Check for high security mode requirements
                if (shareData.highSecurity) {
                    // Check if mobile device
                    if (!isMobileDevice()) {
                        showError('é«˜æ©Ÿå¯†æ¨¡å¼åƒ…é™è¡Œå‹•è£ç½®ä½¿ç”¨ï¼è«‹ä½¿ç”¨æ‰‹æ©Ÿæˆ–å¹³æ¿é›»è…¦å­˜å–ã€‚');
                        return;
                    }
                    
                    // Check if online
                    if (!isOnline()) {
                        showError('é«˜æ©Ÿå¯†æ¨¡å¼éœ€è¦ç¶²è·¯é€£ç·šï¼è«‹é€£æ¥ç¶²è·¯å¾Œé‡è©¦ã€‚');
                        return;
                    }
                    
                    // Check if installed as PWA
                    if (!isInstalledPWA()) {
                        showPWAInstallGuide();
                        return;
                    }
                }
                
                // Validate expiry
                if (shareData.expiry > 0 && Date.now() > shareData.expiry) {
                    showError('æ­¤åˆ†äº«é€£çµå·²éæœŸï¼');
                    return;
                }
                
                // Check view limit
                if (shareData.viewLimit > 0) {
                    const viewCountKey = 'share_view_count_' + shareId;
                    const viewCount = parseInt(localStorage.getItem(viewCountKey) || '0');
                    
                    if (viewCount >= shareData.viewLimit) {
                        showError('æ­¤åˆ†äº«é€£çµçš„æŸ¥çœ‹æ¬¡æ•¸å·²é”ä¸Šé™ï¼');
                        return;
                    }
                    
                    // Show remaining views
                    const remaining = shareData.viewLimit - viewCount;
                    document.getElementById('viewCountInfo').style.display = 'block';
                    document.getElementById('viewCountText').textContent = ` æ­¤é€£çµé‚„å¯ä»¥ä½¿ç”¨ ${remaining} æ¬¡`;
                }
                
                // Check for high security mode with time-limited no-auth access
                if (shareData.highSecurity && shareData.noAuthDuration > 0) {
                    const activationKey = 'share_activated_' + shareId;
                    const activationTime = parseInt(localStorage.getItem(activationKey) || '0');
                    
                    if (activationTime > 0) {
                        const elapsed = Date.now() - activationTime;
                        if (elapsed < shareData.noAuthDuration) {
                            // Still within no-auth period, skip passcode setup
                            await savePasswordsDirectly();
                            return;
                        } else {
                            // No-auth period expired, need to re-authenticate
                            localStorage.removeItem(activationKey);
                        }
                    }
                }
                
                // Display passwords
                displayPasswords();
                
                // Show setup section
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('setupSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading shared data:', error);
                showError('ç„¡æ³•è¼‰å…¥åˆ†äº«å…§å®¹ï¼é€£çµå¯èƒ½å·²æå£æˆ–ç„¡æ•ˆã€‚');
            }
        }

        function displayPasswords() {
            const passwordList = document.getElementById('passwordList');
            passwordList.innerHTML = '<h4 style="margin-bottom: 15px; color: #333;">æ‚¨å°‡æ¥æ”¶ä»¥ä¸‹å¯†ç¢¼ï¼š</h4>';
            
            if (shareData.passwords.comment) {
                const item = document.createElement('div');
                item.className = 'password-item';
                item.innerHTML = `
                    <h4>ğŸ”‘ éŠ³è©•å¯†ç¢¼</h4>
                    <p>ç”¨æ–¼æŸ¥çœ‹åº§è™Ÿè©•åƒ¹çš„éŠ³è©•å…§å®¹</p>
                `;
                passwordList.appendChild(item);
            }
            
            if (shareData.passwords.query) {
                const item = document.createElement('div');
                item.className = 'password-item';
                item.innerHTML = `
                    <h4>ğŸ”„ æŸ¥è©¢å¯†ç¢¼</h4>
                    <p>ç”¨æ–¼å¤šæ¬¡æŸ¥è©¢åº§è™Ÿè©•åƒ¹</p>
                `;
                passwordList.appendChild(item);
            }
        }

        function showSuccess(storedPasswords) {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('successSection').style.display = 'block';
            
            const successText = `å·²æˆåŠŸå„²å­˜ ${storedPasswords.join('ã€')}ï¼\nå¯†ç¢¼å·²åŠ å¯†å„²å­˜åœ¨æ‚¨çš„è£ç½®ä¸Šã€‚`;
            document.getElementById('successText').textContent = successText;
            
            let nextSteps = 'æ‚¨ç¾åœ¨å¯ä»¥ï¼š\n';
            if (shareData.passwords.comment) {
                nextSteps += 'â€¢ å‰å¾€ä¸»é ï¼ŒæŸ¥è©¢åº§è™Ÿå¾Œä½¿ç”¨æ‚¨çš„é€šè¡Œç¢¼æŸ¥çœ‹éŠ³è©•\n';
            }
            if (shareData.passwords.query) {
                nextSteps += 'â€¢ å‰å¾€ä¸»é ï¼Œä½¿ç”¨æ‚¨çš„é€šè¡Œç¢¼é€²è¡Œå¤šæ¬¡æŸ¥è©¢\n';
            }
            nextSteps += '\nè«‹å¦¥å–„ä¿ç®¡æ‚¨çš„4ä½æ•¸é€šè¡Œç¢¼ï¼';
            
            document.getElementById('nextStepsText').textContent = nextSteps;
        }

        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        // Load shared data on page load
        window.addEventListener('DOMContentLoaded', loadSharedData);

        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>

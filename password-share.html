<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†ç¢¼åˆ†äº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 700px;
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #f5576c;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .login-section {
            display: block;
        }

        .share-panel {
            display: none;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-size: 1.1em;
            color: #333;
            font-weight: bold;
            margin-bottom: 10px;
        }

        input[type="password"], input[type="text"], input[type="number"] {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        input[type="password"]:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #f5576c;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: #f5576c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
            margin-top: 10px;
        }

        button:hover {
            background: #e04656;
        }

        button:active {
            transform: scale(0.98);
        }

        button.secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.generate-btn {
            background: #28a745;
        }

        button.generate-btn:hover {
            background: #218838;
        }

        .checkbox-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .checkbox-item {
            margin-bottom: 15px;
        }

        .checkbox-item label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .password-preview {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            color: #0c5460;
        }

        .share-result {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .share-result h3 {
            color: #155724;
            margin-bottom: 15px;
        }

        .share-url {
            background: white;
            padding: 15px;
            border-radius: 5px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .copy-btn {
            width: auto;
            padding: 10px 20px;
            font-size: 1em;
            margin-top: 10px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #28a745;
            margin-bottom: 20px;
            display: none;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 5px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-box h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #0c5460;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
        }

        .back-link a {
            color: #f5576c;
            text-decoration: none;
            font-size: 1em;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .view-limit-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— å¯†ç¢¼åˆ†äº«</h1>
        
        <div class="login-section" id="loginSection">
            <div class="info-box">
                <h4>ğŸ“‹ åŠŸèƒ½èªªæ˜</h4>
                <p>
                    å®‰å…¨åœ°åˆ†äº«å¯†ç¢¼çµ¦å…¶ä»–ä½¿ç”¨è€…ï¼š<br>
                    â€¢ æ”¶åˆ°é€£çµçš„ä½¿ç”¨è€…ç„¡æ³•ç›´æ¥æŸ¥çœ‹å¯†ç¢¼<br>
                    â€¢ ä»–å€‘å¿…é ˆè¨­å®šè‡ªå·±çš„é€šè¡Œç¢¼ä¾†ä¿è­·å¯†ç¢¼<br>
                    â€¢ å¯ä»¥è¨­å®šæŸ¥çœ‹æ¬¡æ•¸é™åˆ¶<br>
                    â€¢ æ•´å€‹éç¨‹ä¸­æ²’æœ‰äººèƒ½çœ‹åˆ°æ˜æ–‡å¯†ç¢¼
                </p>
            </div>

            <div class="error-message" id="loginError"></div>
            
            <div class="input-group">
                <label for="adminPassword">ç®¡ç†å“¡å¯†ç¢¼ï¼š</label>
                <input type="password" id="adminPassword" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼">
            </div>
            
            <button onclick="login()">ç™»å…¥</button>
            
            <div class="back-link">
                <a href="admin.html">â† è¿”å›ç®¡ç†å“¡é é¢</a> | 
                <a href="index.html">è¿”å›ä¸»é </a>
            </div>
        </div>

        <div class="share-panel" id="sharePanel">
            <div class="error-message" id="shareError"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div class="input-group">
                <label>é¸æ“‡è¦åˆ†äº«çš„å¯†ç¢¼ï¼š</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" id="shareCommentPassword">
                            éŠ³è©•å¯†ç¢¼
                            <span class="password-preview" id="commentPasswordPreview">è¼‰å…¥ä¸­...</span>
                        </label>
                    </div>
                    <div class="checkbox-item">
                        <label>
                            <input type="checkbox" id="shareQueryPassword">
                            æŸ¥è©¢å¯†ç¢¼
                            <span class="password-preview" id="queryPasswordPreview">è¼‰å…¥ä¸­...</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label>æŸ¥çœ‹é™åˆ¶è¨­å®šï¼š</label>
                <div class="view-limit-group">
                    <div>
                        <label style="font-size: 0.9em;">æŸ¥çœ‹æ¬¡æ•¸ï¼ˆ0 = ç„¡é™åˆ¶ï¼‰</label>
                        <input type="number" id="viewLimit" value="1" min="0" max="100">
                    </div>
                    <div>
                        <label style="font-size: 0.9em;">æœ‰æ•ˆæœŸé™ï¼ˆå¤©æ•¸ï¼Œ0 = ç„¡é™æœŸï¼‰</label>
                        <input type="number" id="expiryDays" value="7" min="0" max="365">
                    </div>
                </div>
            </div>

            <button class="generate-btn" onclick="generateShareLink()">ç”Ÿæˆåˆ†äº«é€£çµ</button>

            <div class="share-result" id="shareResult">
                <h3>âœ… åˆ†äº«é€£çµå·²ç”Ÿæˆ</h3>
                <p style="color: #155724; margin-bottom: 10px;">è«‹å°‡æ­¤é€£çµåˆ†äº«çµ¦éœ€è¦çš„ä½¿ç”¨è€…ï¼š</p>
                <div class="share-url" id="shareUrl"></div>
                <button class="copy-btn" onclick="copyShareLink()">ğŸ“‹ è¤‡è£½é€£çµ</button>
            </div>

            <div class="info-box">
                <h4>ğŸ”’ å®‰å…¨æç¤º</h4>
                <p>
                    <strong>åˆ†äº«æµç¨‹ï¼š</strong><br>
                    1. é¸æ“‡è¦åˆ†äº«çš„å¯†ç¢¼ï¼ˆå¯å¤šé¸ï¼‰<br>
                    2. è¨­å®šæŸ¥çœ‹æ¬¡æ•¸å’Œæœ‰æ•ˆæœŸé™<br>
                    3. ç”ŸæˆåŠ å¯†çš„åˆ†äº«é€£çµ<br>
                    4. æ”¶åˆ°é€£çµçš„ä½¿ç”¨è€…å¿…é ˆå…ˆè¨­å®šè‡ªå·±çš„4ä½æ•¸é€šè¡Œç¢¼<br>
                    5. å¯†ç¢¼æœƒä»¥åŠ å¯†å½¢å¼å„²å­˜åœ¨ä»–å€‘çš„è£ç½®ä¸Š<br>
                    6. ä»–å€‘ä¹‹å¾Œä½¿ç”¨é€šè¡Œç¢¼ä¾†è§£é–å¯†ç¢¼ä½¿ç”¨<br><br>
                    <strong>æ³¨æ„ï¼š</strong>æ•´å€‹éç¨‹ä¸­ï¼Œæ²’æœ‰äººèƒ½ç›´æ¥çœ‹åˆ°å¯†ç¢¼çš„æ˜æ–‡å…§å®¹ï¼
                </p>
            </div>

            <button class="secondary" onclick="logout()">ç™»å‡º</button>
            
            <div class="back-link">
                <a href="admin.html">â† è¿”å›ç®¡ç†å“¡é é¢</a> | 
                <a href="index.html">è¿”å›ä¸»é </a>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'RAN+';
        let isLoggedIn = false;
        let currentCommentPassword = '';
        let currentQueryPassword = '';

        // AES-like encryption using Web Crypto API
        async function encryptData(data, password) {
            const encoder = new TextEncoder();
            const dataBuffer = encoder.encode(data);
            const passwordBuffer = encoder.encode(password);
            
            // Create key from password
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                passwordBuffer,
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );
            
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt']
            );
            
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encryptedData = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                dataBuffer
            );
            
            // Combine salt, iv, and encrypted data
            const result = new Uint8Array(salt.length + iv.length + encryptedData.byteLength);
            result.set(salt, 0);
            result.set(iv, salt.length);
            result.set(new Uint8Array(encryptedData), salt.length + iv.length);
            
            // Convert to base64
            return btoa(String.fromCharCode.apply(null, result));
        }

        async function decryptData(encryptedBase64, password) {
            try {
                const encrypted = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                
                const salt = encrypted.slice(0, 16);
                const iv = encrypted.slice(16, 28);
                const data = encrypted.slice(28);
                
                const encoder = new TextEncoder();
                const passwordBuffer = encoder.encode(password);
                
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordBuffer,
                    'PBKDF2',
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                
                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                
                const decoder = new TextDecoder();
                return decoder.decode(decryptedData);
            } catch (error) {
                throw new Error('è§£å¯†å¤±æ•—');
            }
        }

        async function loadPasswords() {
            try {
                const response = await fetch('data.csv');
                const text = await response.text();
                parsePasswords(text);
                displayPasswordPreviews();
            } catch (error) {
                showShareError('ç„¡æ³•è¼‰å…¥å¯†ç¢¼è³‡æ–™');
            }
        }

        function parsePasswords(text) {
            const lines = text.trim().split('\n');
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('å¯†ç¢¼,')) {
                    const parts = lines[i].split(',');
                    if (parts[1]) {
                        currentCommentPassword = parts[1].trim();
                    }
                    if (parts[2]) {
                        currentQueryPassword = parts[2].trim();
                    }
                    break;
                }
            }
        }

        function displayPasswordPreviews() {
            const commentPreview = document.getElementById('commentPasswordPreview');
            const queryPreview = document.getElementById('queryPasswordPreview');
            
            if (currentCommentPassword) {
                commentPreview.textContent = maskPassword(currentCommentPassword);
            } else {
                commentPreview.textContent = 'æœªè¨­å®š';
                document.getElementById('shareCommentPassword').disabled = true;
            }
            
            if (currentQueryPassword) {
                queryPreview.textContent = maskPassword(currentQueryPassword);
            } else {
                queryPreview.textContent = 'æœªè¨­å®š';
                document.getElementById('shareQueryPassword').disabled = true;
            }
        }

        function maskPassword(password) {
            if (password.length <= 4) {
                return '*'.repeat(password.length);
            }
            return password.substring(0, 2) + '*'.repeat(password.length - 4) + password.substring(password.length - 2);
        }

        function login() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('sharePanel').style.display = 'block';
                loadPasswords();
            } else {
                showLoginError('ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        function logout() {
            isLoggedIn = false;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('sharePanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('shareResult').style.display = 'none';
        }

        async function generateShareLink() {
            const shareComment = document.getElementById('shareCommentPassword').checked;
            const shareQuery = document.getElementById('shareQueryPassword').checked;
            
            if (!shareComment && !shareQuery) {
                showShareError('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å¯†ç¢¼é€²è¡Œåˆ†äº«ï¼');
                return;
            }

            const viewLimit = parseInt(document.getElementById('viewLimit').value) || 0;
            const expiryDays = parseInt(document.getElementById('expiryDays').value) || 0;
            
            // Calculate expiry timestamp
            let expiryTimestamp = 0;
            if (expiryDays > 0) {
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + expiryDays);
                expiryTimestamp = expiryDate.getTime();
            }
            
            // Generate a random encryption key for this share
            const shareKey = generateRandomKey(32);
            
            // Create share data
            const shareData = {
                passwords: {},
                viewLimit: viewLimit,
                expiry: expiryTimestamp,
                created: Date.now()
            };
            
            if (shareComment) {
                shareData.passwords.comment = currentCommentPassword;
            }
            if (shareQuery) {
                shareData.passwords.query = currentQueryPassword;
            }
            
            // Encrypt the share data
            const encryptedData = await encryptData(JSON.stringify(shareData), shareKey);
            
            // Create URL
            const baseUrl = window.location.origin + window.location.pathname.replace('password-share.html', '');
            const shareUrl = `${baseUrl}password-receive.html?data=${encodeURIComponent(encryptedData)}&key=${encodeURIComponent(shareKey)}`;
            
            // Display result
            document.getElementById('shareUrl').textContent = shareUrl;
            document.getElementById('shareResult').style.display = 'block';
            
            showSuccess('åˆ†äº«é€£çµå·²ç”Ÿæˆï¼');
        }

        function generateRandomKey(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let key = '';
            for (let i = 0; i < length; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return key;
        }

        function copyShareLink() {
            const shareUrl = document.getElementById('shareUrl').textContent;
            navigator.clipboard.writeText(shareUrl).then(() => {
                showSuccess('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showShareError(message) {
            const errorDiv = document.getElementById('shareError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }
    </script>
</body>
</html>

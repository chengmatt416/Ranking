<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•Ÿç”¨ç¢¼åˆ†äº«</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#667eea">
    
    <!-- iOS specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è©•åƒ¹ç³»çµ±">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Icons for various platforms -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 700px;
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .login-section {
            display: block;
        }

        .share-panel {
            display: none;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-size: 1.1em;
            color: #333;
            font-weight: bold;
            margin-bottom: 10px;
        }

        input[type="password"], input[type="text"], input[type="number"] {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        input[type="password"]:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        button:active {
            transform: scale(0.98);
        }

        button.secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.generate-btn {
            background: #28a745;
        }

        button.generate-btn:hover {
            background: #218838;
        }

        .radio-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .radio-item {
            margin-bottom: 15px;
        }

        .radio-item label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .share-result {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .share-result h3 {
            color: #155724;
            margin-bottom: 15px;
        }

        .share-url {
            background: white;
            padding: 15px;
            border-radius: 5px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .copy-btn {
            width: auto;
            padding: 10px 20px;
            font-size: 1em;
            margin-top: 10px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #28a745;
            margin-bottom: 20px;
            display: none;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 5px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-box h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #0c5460;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
        }

        .back-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 1em;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .qrcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }

        .qrcode-container h4 {
            color: #155724;
            margin-bottom: 15px;
        }

        #qrcode {
            display: inline-block;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— å•Ÿç”¨ç¢¼åˆ†äº«</h1>
        
        <div class="login-section" id="loginSection">
            <div class="info-box">
                <h4>ğŸ“‹ åŠŸèƒ½èªªæ˜</h4>
                <p>
                    å®‰å…¨åœ°åˆ†äº«å•Ÿç”¨ç¢¼çµ¦å…¶ä»–ä½¿ç”¨è€…ï¼š<br>
                    â€¢ ç”Ÿæˆå¸¶æœ‰é€£çµçš„å•Ÿç”¨ç¢¼ï¼Œæ–¹ä¾¿ä¸€éµä½¿ç”¨<br>
                    â€¢ å¯ä»¥è¨­å®šä½¿ç”¨æ¬¡æ•¸é™åˆ¶<br>
                    â€¢ å¯ä»¥è¨­å®šæœ‰æ•ˆæœŸé™<br>
                    â€¢ è‡ªå‹•ç”Ÿæˆ QR Code æ–¹ä¾¿æ‰‹æ©Ÿæƒæ
                </p>
            </div>

            <div class="error-message" id="loginError"></div>
            
            <div class="input-group">
                <label for="adminPassword">ç®¡ç†å“¡å¯†ç¢¼ï¼š</label>
                <input type="password" id="adminPassword" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼">
            </div>
            
            <button onclick="login()">ç™»å…¥</button>
            
            <div class="back-link">
                <a href="admin.html">â† è¿”å›ç®¡ç†å“¡é é¢</a> | 
                <a href="index.html">è¿”å›ä¸»é </a>
            </div>
        </div>

        <div class="share-panel" id="sharePanel">
            <div class="error-message" id="shareError"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div class="input-group">
                <label>é¸æ“‡å•Ÿç”¨ç¢¼é¡å‹ï¼š</label>
                <div class="radio-group">
                    <div class="radio-item">
                        <label>
                            <input type="radio" name="codeType" value="survey" checked>
                            å•å·å•Ÿç”¨ç¢¼ - ç”¨æ–¼å¡«å¯«è©•åƒ¹å•å·
                        </label>
                    </div>
                    <div class="radio-item">
                        <label>
                            <input type="radio" name="codeType" value="comment">
                            éŠ³è©•ç·¨è¼¯å•Ÿç”¨ç¢¼ - ç”¨æ–¼ç·¨è¼¯éŠ³è©•å…§å®¹
                        </label>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label>å•Ÿç”¨ç¢¼é…ç½®ï¼š</label>
                <div class="config-grid">
                    <div>
                        <label style="font-size: 0.9em;">åº§è™Ÿ</label>
                        <input type="number" id="seatNumber" min="1" max="50" placeholder="å¡«å¯«è€…/ç·¨è¼¯è€…åº§è™Ÿ">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label>æœ‰æ•ˆæœŸé™è¨­å®šï¼ˆç²¾ç¢ºåˆ°åˆ†é˜ï¼‰ï¼š</label>
                <div class="config-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.9em;">å¤©æ•¸</label>
                        <input type="number" id="validDays" value="7" min="0" max="365">
                    </div>
                    <div>
                        <label style="font-size: 0.9em;">å°æ™‚</label>
                        <input type="number" id="validHours" value="0" min="0" max="23">
                    </div>
                    <div>
                        <label style="font-size: 0.9em;">åˆ†é˜</label>
                        <input type="number" id="validMinutes" value="0" min="0" max="59">
                    </div>
                </div>
                <p style="font-size: 0.85em; color: #666; margin-top: 8px;">è‡³å°‘éœ€è¦è¨­å®šä¸€å€‹éé›¶å€¼</p>
            </div>

            <button class="generate-btn" onclick="generateShareLink()">ç”Ÿæˆåˆ†äº«é€£çµ</button>

            <div class="share-result" id="shareResult">
                <h3>âœ… åˆ†äº«é€£çµå·²ç”Ÿæˆ</h3>
                <p style="color: #155724; margin-bottom: 10px;">è«‹å°‡æ­¤é€£çµåˆ†äº«çµ¦éœ€è¦çš„ä½¿ç”¨è€…ï¼š</p>
                <div class="share-url" id="shareUrl"></div>
                <button class="copy-btn" onclick="copyShareLink()">ğŸ“‹ è¤‡è£½é€£çµ</button>
                
                <div class="qrcode-container">
                    <h4>ğŸ“± æƒæ QR Code</h4>
                    <div id="qrcode"></div>
                </div>
            </div>

            <div class="info-box">
                <h4>ğŸ”’ ä½¿ç”¨èªªæ˜</h4>
                <p>
                    <strong>åˆ†äº«æµç¨‹ï¼š</strong><br>
                    1. é¸æ“‡å•Ÿç”¨ç¢¼é¡å‹ï¼ˆå•å·æˆ–éŠ³è©•ç·¨è¼¯ï¼‰<br>
                    2. è¼¸å…¥åº§è™Ÿå’Œæœ‰æ•ˆæœŸé™ï¼ˆå¤©/å°æ™‚/åˆ†é˜ï¼‰<br>
                    3. ç”Ÿæˆåˆ†äº«é€£çµå’Œ QR Code<br>
                    4. å°‡é€£çµæˆ– QR Code åˆ†äº«çµ¦ä½¿ç”¨è€…<br>
                    5. ä½¿ç”¨è€…é»æ“Šé€£çµå¯ç›´æ¥è·³è½‰ä¸¦è‡ªå‹•å¡«å…¥å•Ÿç”¨ç¢¼<br><br>
                    <strong>æ³¨æ„ï¼š</strong>æ¯å€‹å•Ÿç”¨ç¢¼åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼
                </p>
            </div>

            <button class="secondary" onclick="logout()">ç™»å‡º</button>
            
            <div class="back-link">
                <a href="admin.html">â† è¿”å›ç®¡ç†å“¡é é¢</a> | 
                <a href="index.html">è¿”å›ä¸»é </a>
            </div>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="auth.js"></script>
    <script>
        let isLoggedIn = false;

        async function login() {
            const password = document.getElementById('adminPassword').value;
            
            const isValid = await verifyAdminPassword(password);
            if (isValid) {
                isLoggedIn = true;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('sharePanel').style.display = 'block';
            } else {
                showLoginError('ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        function logout() {
            isLoggedIn = false;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('sharePanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('shareResult').style.display = 'none';
        }

        async function generateShareLink() {
            const codeType = document.querySelector('input[name="codeType"]:checked').value;
            const seatNumber = document.getElementById('seatNumber').value;
            const validDays = parseInt(document.getElementById('validDays').value) || 0;
            const validHours = parseInt(document.getElementById('validHours').value) || 0;
            const validMinutes = parseInt(document.getElementById('validMinutes').value) || 0;
            
            if (!seatNumber) {
                showShareError('è«‹è¼¸å…¥åº§è™Ÿï¼');
                return;
            }
            
            if (validDays === 0 && validHours === 0 && validMinutes === 0) {
                showShareError('è«‹è‡³å°‘è¨­å®šä¸€å€‹æœ‰æ•ˆæœŸé™å€¼ï¼ˆå¤©/å°æ™‚/åˆ†é˜ï¼‰ï¼');
                return;
            }

            // Generate activation code
            const activationCode = generateActivationCode(codeType, seatNumber, validDays, validHours, validMinutes);
            
            // Determine target page based on code type
            const targetPage = codeType === 'survey' ? 'survey.html' : 'comment-editor.html';
            
            // Create URL with activation code
            const baseUrl = window.location.origin + window.location.pathname.replace('activation-share.html', '');
            const shareUrl = `${baseUrl}${targetPage}?code=${encodeURIComponent(activationCode)}`;
            
            // Display result
            document.getElementById('shareUrl').textContent = shareUrl;
            document.getElementById('shareResult').style.display = 'block';
            
            // Generate QR Code
            generateQRCode(shareUrl);
            
            showSuccess('åˆ†äº«é€£çµå·²ç”Ÿæˆï¼');
        }

        function generateActivationCode(type, seatNumber, validDays, validHours, validMinutes) {
            // Calculate expiry timestamp with minute precision
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + validDays);
            expiryDate.setHours(expiryDate.getHours() + validHours);
            expiryDate.setMinutes(expiryDate.getMinutes() + validMinutes);
            const expiryTimestamp = expiryDate.getTime();
            
            // Create code based on type
            if (type === 'survey') {
                // Survey activation code format: evaluatorSeat|expiryTimestamp|signature
                const secret = 'RANKING_SECRET_2024';
                const signature = btoa(seatNumber + expiryTimestamp + secret).substring(0, 8);
                const codeData = `${seatNumber}|${expiryTimestamp}|${signature}`;
                return btoa(codeData);
            } else {
                // Comment activation code format: COMMENT|editorSeat|expiryTimestamp|signature
                const secret = 'RANKING_COMMENT_2024';
                const signature = btoa('COMMENT' + seatNumber + expiryTimestamp + secret).substring(0, 8);
                const codeData = `COMMENT|${seatNumber}|${expiryTimestamp}|${signature}`;
                return btoa(codeData);
            }
        }

        function generateQRCode(url) {
            // Clear previous QR code if exists
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            
            // Generate new QR code
            new QRCode(qrcodeContainer, {
                text: url,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function copyShareLink() {
            const shareUrl = document.getElementById('shareUrl').textContent;
            navigator.clipboard.writeText(shareUrl).then(() => {
                showSuccess('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showShareError(message) {
            const errorDiv = document.getElementById('shareError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
